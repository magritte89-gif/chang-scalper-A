<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì°½í˜ ë‹¨íƒ€ ì‹œë®¬ë ˆì´í„° A-Ver</title>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      background: #1e1e1e;
      color: #dedede;
      font-family: "Noto Sans KR", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
    }

    .app-wrapper {
      max-width: 1100px;
      margin: 0 auto;
    }

    h1, h2, h3, h4 {
      margin: 0;
      padding: 0;
    }

    .card {
      background: #242424;
      border-radius: 10px;
      padding: 18px 20px;
      margin-bottom: 16px;
      box-shadow: 0 0 0 1px #333;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .header-emoji {
      font-size: 24px;
    }

    .sub-text {
      font-size: 13px;
      color: #a0a0a0;
      margin-top: 4px;
    }

    label {
      display: block;
      font-size: 14px;
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #141414;
      color: #f1f1f1;
      font-size: 14px;
      outline: none;
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
      border-color: #5aa9ff;
      box-shadow: 0 0 0 1px #5aa9ff55;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1.3fr 1.7fr;
      gap: 16px;
      margin-top: 10px;
      margin-bottom: 12px;
    }

    @media (max-width: 768px) {
      .input-row {
        grid-template-columns: 1fr;
      }
    }

    .btn-primary {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: #5aa9ff;
      color: #0b0b0b;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      margin-top: 6px;
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.1s ease;
    }

    .btn-primary:hover {
      background: #7bb9ff;
      box-shadow: 0 0 0 1px #7bb9ff55;
      transform: translateY(-1px);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .notice-text {
      font-size: 12px;
      color: #888;
      margin-top: 10px;
      line-height: 1.5;
    }

    #analysis {
      font-size: 14px;
      line-height: 1.6;
      white-space: normal;
    }

    .highlight-box {
      background: #181818;
      border-radius: 8px;
      padding: 10px 12px;
      margin: 8px 0;
      border: 1px solid #383838;
      font-size: 13px;
      line-height: 1.7;
    }

    .tag {
      display: inline-block;
      padding: 4px 8px;
      margin: 2px 3px;
      border-radius: 999px;
      background: #333;
      font-size: 12px;
      color: #f5f5f5;
    }

    hr {
      border: none;
      border-top: 1px solid #333;
      margin: 12px 0;
    }
  </style>
</head>

<body>
  <div class="app-wrapper">
    <!-- 1) ê¸°ë³¸ ì…ë ¥ -->
    <div class="card">
      <div class="header">
        <div class="header-emoji">ğŸ“Š</div>
        <div>
          <h2>ì°½í˜ ë‹¨íƒ€ ì‹œë®¬ë ˆì´í„° A-Ver</h2>
          <div class="sub-text">1) ê¸°ë³¸ ì…ë ¥</div>
        </div>
      </div>

      <div class="input-row">
        <div>
          <label for="ticker">ì¢…ëª© ì½”ë“œ (ì˜ˆ: 005930)</label>
          <input id="ticker" type="text" placeholder="ìˆ«ì 6ìë¦¬ ë˜ëŠ” ì‹¬ë³¼" />
        </div>
        <div>
          <label for="capital">íˆ¬ì ê°€ëŠ¥í•œ ì´ ìë³¸(ì›)</label>
          <input id="capital" type="text" placeholder="ì˜ˆ: 1,000,000" />
        </div>
      </div>

      <button class="btn-primary" onclick="fetchData()">ë°ì´í„° ë¡œë”©í•˜ê¸°</button>

      <div class="notice-text">
        Â· ì¢…ëª© ì½”ë“œëŠ” ìˆ«ì ë˜ëŠ” ì˜ë¬¸ í‹°ì»¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.<br />
        Â· ìë³¸ì„ ì…ë ¥í•˜ë©´, ì˜¤ëŠ˜ ì´ ì¢…ëª©ì— ì“¸ ìˆ˜ ìˆëŠ” ê¶Œì¥ ê¸ˆì•¡/ì£¼ìˆ˜ë¥¼ í•¨ê»˜ ê³„ì‚°í•´ ì¤ë‹ˆë‹¤.
      </div>
    </div>

    <!-- 2) ìë™ ë¶„ì„ ê²°ê³¼ & ì˜¤ëŠ˜ì˜ ì „ëµ -->
    <div class="card">
      <div class="header">
        <div class="header-emoji">ğŸ§ </div>
        <div>
          <h3>ìë™ ë¶„ì„ ê²°ê³¼ &amp; ì˜¤ëŠ˜ì˜ ì „ëµ</h3>
        </div>
      </div>

      <div id="analysis">
        ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì ‘ì† ë¬¸ì œì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.<br />
        (ì•„ì§ ì¡°íšŒ ì „ì´ë¼ë©´, ìœ„ì—ì„œ ì¢…ëª© ì½”ë“œì™€ ìë³¸ì„ ì…ë ¥í•œ ë’¤
        <b>ë°ì´í„° ë¡œë”©í•˜ê¸°</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.)
      </div>
    </div>
  </div>

  <script>
    // âš™ï¸ API ì„œë²„ ì£¼ì†Œ (Render ë°±ì—”ë“œ URL)
    const API_BASE = "https://chang-scalper-api.onrender.com";

    // ----------------------------
    // 1. ë°ì´í„° ìš”ì²­ í•¨ìˆ˜
    // ----------------------------
    async function fetchData() {
      const rawTicker = document.getElementById("ticker").value.trim();
      const rawCapital = document.getElementById("capital").value.trim();

      if (!rawTicker) {
        alert("ì¢…ëª© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
      }

      const analysisEl = document.getElementById("analysis");
      analysisEl.innerHTML =
        "ì„œë²„ì— ë¶„ì„ ìš”ì²­ ì¤‘... â³<br><small>ì…ë ¥ ì‹¬ë³¼: " +
        rawTicker +
        (rawCapital ? ", ìë³¸: " + rawCapital : "") +
        "</small>";

      try {
        const url =
          API_BASE +
          "/analyze?symbol=" +
          encodeURIComponent(rawTicker) +
          "&capital=" +
          encodeURIComponent(rawCapital);

        const res = await fetch(url);

        // ë¨¼ì € í…ìŠ¤íŠ¸ë¡œ ë°›ì•˜ë‹¤ê°€ JSON íŒŒì‹± (ì—ëŸ¬ ë‚´ìš© í™•ì¸ìš©)
        const rawText = await res.text();
        let data = null;

        try {
          data = rawText ? JSON.parse(rawText) : null;
        } catch (parseErr) {
          console.error("JSON íŒŒì‹± ì‹¤íŒ¨:", parseErr, rawText);
          analysisEl.innerHTML =
            "âš  ì„œë²„ì—ì„œ ì˜¬ë°”ë¥¸ í˜•ì‹(JSON)ì˜ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>" +
            `<small>HTTP ${res.status} ${res.statusText}<br>` +
            `ì‘ë‹µ ë‚´ìš©(ì•ë¶€ë¶„): ${rawText.slice(0, 200)}</small>`;
          return;
        }

        if (!res.ok || !data || data.error) {
          const msg =
            (data && (data.message || data.error)) ||
            `HTTP ${res.status} ${res.statusText}`;
          analysisEl.innerHTML =
            "âš  ì„œë²„ ì˜¤ë¥˜ ë˜ëŠ” ì‹¬ë³¼/ìë³¸ ì…ë ¥ ë¬¸ì œ<br><small>" + msg + "</small>";
          return;
        }

        showResult(data);
      } catch (e) {
        console.error("ë„¤íŠ¸ì›Œí¬/JS ì˜¤ë¥˜:", e);
        analysisEl.innerHTML =
          "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì ‘ì† ë¬¸ì œì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.<br>" +
          `<small>${e.message || e}</small>`;
      }
    }

    // ----------------------------
    // 2. ê²°ê³¼ í™”ë©´ ì¶œë ¥
    // ----------------------------
    function showResult(data) {
      const today = data.today_close;
      const rsi = data.rsi;
      const signalKor = data.signal_kor || "ì‹ í˜¸ í…ìŠ¤íŠ¸ ì—†ìŒ";
      const reasons = Array.isArray(data.reasons) ? data.reasons : [];
      const strategy = data.strategy_text || "";

      const capital = data.capital_input;
      const budget = data.position_budget;
      const sharesTotal = data.shares_total;
      const pos1Shares = data.pos1_shares;
      const pos2Shares = data.pos2_shares;
      const pos3Shares = data.pos3_shares;
      const pos1Amount = data.pos1_amount;
      const pos2Amount = data.pos2_amount;
      const pos3Amount = data.pos3_amount;

      const strategyHtml = strategy
        ? strategy.replace(/\n/g, "<br>")
        : "ì „ëµ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.";

      const rsiText =
        typeof rsi === "number" && !isNaN(rsi) ? rsi.toFixed(1) : "-";

      let positionHtml = "";
      if (capital && budget && sharesTotal && sharesTotal > 0) {
        positionHtml = `
          <div class="highlight-box">
            <b>ğŸ’° ì˜¤ëŠ˜ ì´ ì¢…ëª©ì— ì“¸ ìˆ˜ ìˆëŠ” ê¶Œì¥ ê¸ˆì•¡ (ì˜ˆì‹œ)</b><br>
            Â· ì…ë ¥ ìë³¸: <b>${numberWithCommas(capital)}ì›</b><br>
            Â· ì´ ì¢…ëª©ì— ì‚¬ìš©í•  ìµœëŒ€ ê¸ˆì•¡ (ìë³¸ì˜ 10% ê°€ì •): <b>${numberWithCommas(
              budget
            )}ì›</b><br>
            Â· í˜„ì¬ê°€ ê¸°ì¤€ ì´ ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰: <b>${numberWithCommas(
              sharesTotal
            )}ì£¼</b><br><br>
            <b>í‘œì¤€í˜• ë¶„í•  ë§¤ìˆ˜ (40% / 30% / 30%)</b><br>
            Â· 1ì°¨: <b>${numberWithCommas(
              pos1Shares
            )}ì£¼</b> (ì•½ ${numberWithCommas(pos1Amount)}ì›)<br>
            Â· 2ì°¨: <b>${numberWithCommas(
              pos2Shares
            )}ì£¼</b> (ì•½ ${numberWithCommas(pos2Amount)}ì›)<br>
            Â· 3ì°¨: <b>${numberWithCommas(
              pos3Shares
            )}ì£¼</b> (ì•½ ${numberWithCommas(pos3Amount)}ì›)<br>
          </div>`;
      } else {
        positionHtml = `
          <div class="highlight-box">
            ìë³¸ì„ ì…ë ¥í•˜ì§€ ì•Šì•„ ì˜¤ëŠ˜ ì´ ì¢…ëª©ì— ì“¸ ìˆ˜ ìˆëŠ” ê¶Œì¥ ê¸ˆì•¡/ì£¼ìˆ˜ ê³„ì‚°ì€ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤.<br>
            í™”ë©´ ìƒë‹¨ì— <b>'íˆ¬ì ê°€ëŠ¥í•œ ì´ ìë³¸(ì›)'</b>ì„ ì…ë ¥í•˜ê³  ë‹¤ì‹œ ì¡°íšŒí•˜ë©´,
            êµ¬ì²´ì ì¸ ë¶„í•  ë§¤ìˆ˜ ê¸ˆì•¡ê³¼ ì£¼ìˆ˜ë¥¼ í•¨ê»˜ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>`;
      }

      const resultHTML = `
        <h3>ğŸ“Œ ë¶„ì„ ê²°ê³¼: ${signalKor}</h3>
        <p>ì‹¤ì œ ì¡°íšŒ ì‹¬ë³¼: <b>${data.symbol_used || "-"}</b></p>
        <p>í˜„ì¬ ê°€ê²©: <b>${numberWithCommas(today)}ì›</b></p>
        <p>5ì¼ì„  / 20ì¼ì„ : <b>${numberWithCommas(
          data.ma5
        )} / ${numberWithCommas(data.ma20)}</b></p>
        <p>ê¸ˆì¼ ê±°ë˜ëŸ‰ / ì „ì¼ ê±°ë˜ëŸ‰: <b>${numberWithCommas(
          data.volume_today
        )} / ${numberWithCommas(data.volume_prev)}</b></p>
        <p>RSI(14): <b>${rsiText}</b></p>

        <h4>â‘  ì¡°ê±´ ì¶©ì¡± ë‚´ì—­</h4>
        ${
          reasons.length
            ? reasons.map((r) => `<div class='tag'>${r}</div>`).join("")
            : "<small>ì¶©ì¡±ëœ ì¡°ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</small>"
        }

        <hr/>
        <h4>â‘¡ ì˜¤ëŠ˜ì˜ ì†ì ˆ/ìµì ˆ ì°¸ê³  ê°€ê²©</h4>
        Â· ì†ì ˆê°€(ì•½ -3%): <b>${numberWithCommas(
          data.stop_loss_price
        )}ì›</b><br>
        Â· 1ì°¨ ìµì ˆ(+5%): <b>${numberWithCommas(
          data.tp1_price
        )}ì›</b><br>
        Â· 2ì°¨ ìµì ˆ(+7%): <b>${numberWithCommas(
          data.tp2_price
        )}ì›</b><br>
        <small>â€» ìœ„ ê°€ê²©ì€ ì°¸ê³ ìš© ê°€ì´ë“œì´ë©°, ì‹¤ì œ ë§¤ë§¤ëŠ” ë³¸ì¸ íŒë‹¨ê³¼ ì›ì¹™ì´ ìµœìš°ì„ ì…ë‹ˆë‹¤.</small>

        <hr/>
        <h4>â‘¢ ì˜¤ëŠ˜ ì´ ì¢…ëª©ì— ì“¸ ìˆ˜ ìˆëŠ” ê¶Œì¥ ê¸ˆì•¡/ì£¼ìˆ˜</h4>
        ${positionHtml}

        <hr/>
        <h4>â‘£ ì˜¤ëŠ˜ì˜ ë§¤ë§¤ ì‹œë‚˜ë¦¬ì˜¤ (Step-by-Step ê°€ì´ë“œ)</h4>
        ${strategyHtml}
      `;

      document.getElementById("analysis").innerHTML = resultHTML;
    }

    // ìˆ«ì ì²œ ë‹¨ìœ„ ì½¤ë§ˆ â€“ ì•ˆì „í•œ ë²„ì „
    function numberWithCommas(x) {
      if (x === null || x === undefined || isNaN(x)) return "-";
      try {
        return Number(x).toLocaleString("ko-KR");
      } catch (e) {
        return x.toString();
      }
    }
  </script>
</body>
</html>
