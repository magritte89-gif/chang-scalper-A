<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì°½í˜ ë‹¨íƒ€ ì‹œë®¬ë ˆì´í„° A-Ver</title>

<style>
    body {
        background: #1e1e1e;
        color: #dedede;
        font-family: 'Noto Sans KR', sans-serif;
        margin: 0;
        padding: 15px;
        box-sizing: border-box;
    }
    .container {
        max-width: 1100px;
        margin: 0 auto;
    }
    h1 {
        font-size: 1.4rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    h1 span.icon {
        font-size: 1.6rem;
    }
    .section {
        background: #262626;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 16px;
        box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }
    .section-title {
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 1rem;
    }
    label {
        display: block;
        font-size: 0.85rem;
        margin-bottom: 4px;
        color: #cccccc;
    }
    input[type="text"], input[type="number"] {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #555;
        background: #1a1a1a;
        color: #f0f0f0;
        font-size: 0.9rem;
        box-sizing: border-box;
    }
    input[type="text"]::placeholder,
    input[type="number"]::placeholder {
        color: #777;
    }
    .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    .col {
        flex: 1 1 200px;
    }
    button {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: none;
        background: #4caf50;
        color: white;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        margin-top: 10px;
    }
    button:hover {
        background: #43a047;
    }
    .info-text {
        font-size: 0.8rem;
        color: #aaaaaa;
        margin-top: 6px;
        line-height: 1.4;
    }
    #analysis, #strategy {
        font-size: 0.9rem;
        line-height: 1.6;
    }
    .tag {
        background: #444;
        padding: 4px 8px;
        border-radius: 4px;
        margin-right: 6px;
        font-size: 0.8rem;
        display: inline-block;
        margin-bottom: 4px;
    }
    hr {
        border: 0;
        border-top: 1px solid #555;
        margin: 15px 0;
    }
    small {
        color: #aaaaaa;
        font-size: 0.8rem;
    }
    .highlight-box {
        background: #262626;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        border: 1px solid #444;
        font-size: 0.85rem;
    }
    @media (max-width: 600px) {
        .row {
            flex-direction: column;
        }
    }
</style>
</head>
<body>
<div class="container">
    <h1><span class="icon">ğŸ“Š</span>ì°½í˜ ë‹¨íƒ€ ì‹œë®¬ë ˆì´í„° A-Ver</h1>

    <!-- 1) ê¸°ë³¸ ì…ë ¥ -->
    <div class="section">
        <div class="section-title">1) ê¸°ë³¸ ì…ë ¥</div>
        <div class="row">
            <div class="col">
                <label for="ticker">ì¢…ëª© ì½”ë“œ</label>
                <input id="ticker" type="text" placeholder="ì˜ˆ) 005930, í˜¹ì€ MSFT" />
            </div>
            <div class="col">
                <label for="capital">íˆ¬ì ê°€ëŠ¥í•œ ì´ ìë³¸(ì›)</label>
                <input id="capital" type="text" placeholder="ì˜ˆ) 1,000,000" />
            </div>
        </div>
        <button onclick="fetchData()">ë°ì´í„° ë¡œë”©í•˜ê¸°</button>
        <div class="info-text">
            Â· ì¢…ëª© ì½”ë“œëŠ” ìˆ«ì ë˜ëŠ” ì˜ë¬¸ í‹°ì»¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.<br/>
            Â· ìë³¸ì„ ì…ë ¥í•˜ë©´, ì˜¤ëŠ˜ ì´ ì¢…ëª©ì— ì“¸ ìˆ˜ ìˆëŠ” ê¶Œì¥ ê¸ˆì•¡/ì£¼ìˆ˜ë¥¼ í•¨ê»˜ ê³„ì‚°í•´ ì¤ë‹ˆë‹¤.
        </div>
    </div>

    <!-- 2) ìë™ ë¶„ì„ ê²°ê³¼ & ì˜¤ëŠ˜ì˜ ì „ëµ -->
    <div class="section">
        <div class="section-title">2) ìë™ ë¶„ì„ ê²°ê³¼ & ì˜¤ëŠ˜ì˜ ì „ëµ</div>
        <div id="analysis">ì¢…ëª©ê³¼ ìë³¸ì„ ì…ë ¥ í›„ <b>ë°ì´í„° ë¡œë”©í•˜ê¸°</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</div>
        <hr/>
        <div id="strategy"></div>
    </div>
</div>

<script>
const API_BASE = "https://chang-scalper-api.onrender.com";

// ë©”ì¸: ì„œë²„ì— ë¶„ì„ ìš”ì²­
async function fetchData() {
    const rawTicker = document.getElementById("ticker").value.trim();
    const rawCapital = document.getElementById("capital").value.trim();

    if (!rawTicker) {
        alert("ì¢…ëª© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
    }

    document.getElementById("analysis").innerHTML =
        "ì„œë²„ì— ë¶„ì„ ìš”ì²­ ì¤‘... â³<br><small>ì…ë ¥ ì¢…ëª©: " +
        rawTicker + (rawCapital ? (", ìë³¸: " + rawCapital) : "") +
        "</small>";
    document.getElementById("strategy").innerHTML = "";

    try {
        const url = `${API_BASE}/analyze?symbol=${encodeURIComponent(
            rawTicker
        )}&capital=${encodeURIComponent(rawCapital)}`;

        const res = await fetch(url);
        const contentType = res.headers.get("content-type") || "";

        // 1) HTTP ìƒíƒœ ì½”ë“œ ì²´í¬
        if (!res.ok) {
            let msg = `HTTP ${res.status} ì‘ë‹µ`;
            try {
                if (contentType.includes("application/json")) {
                    const errBody = await res.json();
                    if (errBody.message) msg += ` - ${errBody.message}`;
                } else {
                    const text = await res.text();
                    msg += " / " + text.slice(0, 200);
                }
            } catch (e) {
                // ignore
            }

            document.getElementById("analysis").innerHTML =
                "âš  ì„œë²„ ì˜¤ë¥˜<br><small>" + msg + "</small>";
            return;
        }

        // 2) JSON í˜•ì‹ì¸ì§€ í™•ì¸
        if (!contentType.includes("application/json")) {
            throw new Error("ì„œë²„ ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
        }

        const data = await res.json();

        if (data.error) {
            const msg = data.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            document.getElementById("analysis").innerHTML =
                "âš  ì„œë²„ ì˜¤ë¥˜ ë˜ëŠ” ì…ë ¥ê°’ ë¬¸ì œ<br><small>" + msg + "</small>";
            return;
        }

        showResult(data);
    } catch (e) {
        console.error(e);
        document.getElementById("analysis").innerHTML =
            "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì ‘ì† ë¬¸ì œì…ë‹ˆë‹¤.<br><small>" +
            (e && e.message ? e.message : e) +
            "</small>";
    }
}

// ê²°ê³¼ í™”ë©´ í‘œì‹œ
function showResult(data) {
    const today = data.today_close;
    const rsiRaw = data.rsi;
    const rsiText =
        typeof rsiRaw === "number" && !isNaN(rsiRaw) ? rsiRaw.toFixed(1) : "-";
    const signalKor = data.signal_kor;
    const reasons = data.reasons || [];
    const strategy = (data.strategy_text || "").replace(/\n/g, "<br>");

    const capital = data.capital_input;
    const budget = data.position_budget;
    const sharesTotal = data.shares_total;
    const pos1Shares = data.pos1_shares;
    const pos2Shares = data.pos2_shares;
    const pos3Shares = data.pos3_shares;
    const pos1Amount = data.pos1_amount;
    const pos2Amount = data.pos2_amount;
    const pos3Amount = data.pos3_amount;

    let positionHtml = "";

    if (
        capital !== null &&
        budget !== null &&
        sharesTotal !== null &&
        sharesTotal > 0
    ) {
        positionHtml = `
        <div class="highlight-box">
            <b>ì…ë ¥ ìë³¸:</b> ì•½ ${numberWithCommas(capital)}ì›<br>
            <b>ì´ ì¢…ëª©ì— ì‚¬ìš©í•  ìµœëŒ€ ê¸ˆì•¡(ìë³¸ì˜ 10% ê°€ì •):</b> ì•½ ${numberWithCommas(budget)}ì›<br>
            <b>ì´ ë§¤ìˆ˜ ê°€ëŠ¥ ìˆ˜ëŸ‰:</b> ì•½ ${numberWithCommas(sharesTotal)}ì£¼<br><br>
            <b>í‘œì¤€í˜• ë¶„í•  ë§¤ìˆ˜ (40% / 30% / 30%) ê¸°ì¤€</b><br>
            Â· 1ì°¨: ${numberWithCommas(pos1Shares)}ì£¼ (ì•½ ${numberWithCommas(pos1Amount)}ì›)<br>
            Â· 2ì°¨: ${numberWithCommas(pos2Shares)}ì£¼ (ì•½ ${numberWithCommas(pos2Amount)}ì›)<br>
            Â· 3ì°¨: ${numberWithCommas(pos3Shares)}ì£¼ (ì•½ ${numberWithCommas(pos3Amount)}ì›)
        </div>`;
    } else {
        positionHtml = `
        <div class="highlight-box">
            ìë³¸ì„ ì…ë ¥í•˜ì§€ ì•Šì•„ ì˜¤ëŠ˜ ì´ ì¢…ëª©ì— ì“¸ ìˆ˜ ìˆëŠ” ê¶Œì¥ ê¸ˆì•¡/ì£¼ìˆ˜ ê³„ì‚°ì€ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤.<br>
            í™”ë©´ ìƒë‹¨ì— <b>'íˆ¬ì ê°€ëŠ¥í•œ ì´ ìë³¸(ì›)'</b>ì„ ì…ë ¥í•˜ê³  ë‹¤ì‹œ ì¡°íšŒí•˜ë©´,
            êµ¬ì²´ì ì¸ ë¶„í•  ë§¤ìˆ˜ ê¸ˆì•¡ê³¼ ì£¼ìˆ˜ë¥¼ í•¨ê»˜ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>`;
    }

    const resultHTML = `
        <h3>ğŸ“Œ ë¶„ì„ ê²°ê³¼: ${signalKor}</h3>
        <p>ì‹¤ì œ ì¡°íšŒ ì‹¬ë³¼: <b>${data.symbol_used}</b></p>
        <p>í˜„ì¬ ê°€ê²©: <b>${numberWithCommas(today)}ì›</b></p>
        <p>5ì¼ì„  / 20ì¼ì„ : <b>${numberWithCommas(data.ma5)} / ${numberWithCommas(data.ma20)}</b></p>
        <p>ê¸ˆì¼ ê±°ë˜ëŸ‰ / ì „ì¼ ê±°ë˜ëŸ‰: <b>${numberWithCommas(data.volume_today)} / ${numberWithCommas(data.volume_prev)}</b></p>
        <p>RSI(14): <b>${rsiText}</b></p>

        <h4>â‘  ì¡°ê±´ ì¶©ì¡± ë‚´ì—­</h4>
        ${reasons.map(r => `<div class='tag'>${r}</div>`).join("")}

        <hr/>
        <h4>â‘¡ ì˜¤ëŠ˜ì˜ ì†ì ˆ/ìµì ˆ ì°¸ê³  ê°€ê²©</h4>
        Â· ì†ì ˆê°€(ì•½ -3%): <b>${numberWithCommas(data.stop_loss_price)}ì›</b><br>
        Â· 1ì°¨ ìµì ˆ(+5%): <b>${numberWithCommas(data.tp1_price)}ì›</b><br>
        Â· 2ì°¨ ìµì ˆ(+7%): <b>${numberWithCommas(data.tp2_price)}ì›</b><br>
        <small>â€» ìœ„ ê°€ê²©ì€ ì°¸ê³ ìš© ê°€ì´ë“œì´ë©°, ì‹¤ì œ ë§¤ë§¤ëŠ” ë³¸ì¸ íŒë‹¨ê³¼ ì›ì¹™ì´ ìµœìš°ì„ ì…ë‹ˆë‹¤.</small>

        <hr/>
        <h4>â‘¢ ì˜¤ëŠ˜ ì´ ì¢…ëª©ì— ì“¸ ìˆ˜ ìˆëŠ” ê¶Œì¥ ê¸ˆì•¡/ì£¼ìˆ˜</h4>
        ${positionHtml}
    `;

    document.getElementById("analysis").innerHTML = resultHTML;
    document.getElementById("strategy").innerHTML = strategy;
}

// ìˆ«ì ì²œ ë‹¨ìœ„ ì½¤ë§ˆ â€“ ì•ˆì „í•œ ë²„ì „
function numberWithCommas(x) {
    if (x === null || x === undefined || isNaN(x)) return "-";
    try {
        return Number(x).toLocaleString('ko-KR');
    } catch (e) {
        return x.toString();
    }
}
</script>

</body>
</html>
